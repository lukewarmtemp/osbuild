# version: '2'
# mpp-define-image:
#   id: image
#   #10G
#   size: '10737418240'
#   table:
#     uuid: 00000000-0000-4000-a000-000000000001
#     label: gpt
#     partitions:
#       - id: BIOS-BOOT
#         size: 2048
#         type: 21686148-6449-6E6F-744E-656564454649
#         bootable: true
#         uuid: FAC7F1FB-3E8D-4137-A512-961DE09A5549
#       - id: EFI-SYSTEM
#         size: 260096
#         type: C12A7328-F81F-11D2-BA4B-00A0C93EC93B
#         uuid: 68B2905B-DF3E-4FB3-80FA-49D1E773AA33
#       - id: boot
#         size: 786432
#         type: 0FC63DAF-8483-4772-8E79-3D69D8477DE4
#         uuid: 61B2905B-DF3E-4FB3-80FA-49D1E773AA32
#       - id: root
#         # XXX: Dynamically set this size in the future
#         size: 8388608
#         type: 0FC63DAF-8483-4772-8E79-3D69D8477DE4
#         uuid: CA7D7CCB-63ED-4C53-861C-1742536059CC
# sources:
#   org.osbuild.ostree:
#     items:
#       2c39e9b6a6b26226b626f4daf815d5307a96b2cd57463e94f7c618e312a61980:
#         remote:
#           url: https://kojipkgs.fedoraproject.org/ostree/repo/
# pipelines:
#   - mpp-import-pipelines:
#       path: fedora-vars.ipp.yaml
#   - mpp-import-pipeline:
#       path: fedora-build-v2.ipp.yaml
#       id: build
#     runner:
#       mpp-format-string: org.osbuild.fedora{release}
#   - name: container
#     build: name:build
#     stages:
#       - type: org.osbuild.ostree.encapsulate
#         options:
#           filename: ostree-container.tar
#         inputs:
#           commit:
#             type: org.osbuild.ostree
#             origin: org.osbuild.source
#             references:
#               "2c39e9b6a6b26226b626f4daf815d5307a96b2cd57463e94f7c618e312a61980":
#                 ref: fedora/x86_64/coreos/stable
version: '2'
pipelines:
  - mpp-import-pipelines:
      path: fedora-vars.ipp.yaml
  - mpp-import-pipeline:
      path: fedora-build-v2.ipp.yaml
      id: build
    runner:
      mpp-format-string: org.osbuild.fedora{release}
  - name: ostree-tree
    build: name:build
    source-epoch: 1659397331
    stages:
      - type: org.osbuild.rpm.macros
        options:
          filename: /usr/lib/rpm/macros.d/macros.osbuild
          macros:
            _dbpath: /usr/share/rpm
      - type: org.osbuild.rpm
        options:
          gpgkeys:
            mpp-eval: gpgkeys
          dbpath: /usr/share/rpm
          ostree_booted: true
        inputs:
          packages:
            type: org.osbuild.files
            origin: org.osbuild.source
            mpp-depsolve:
              architecture: $arch
              module-platform-id: $module_platform_id
              repos:
                mpp-eval: repos
              packages:
                - '@cloud-server-environment'
                - chrony
                - cryptsetup
                - dracut-config-generic
                - greenboot-grub2
                - greenboot-reboot
                - greenboot-rpm-ostree-grub2
                - greenboot-status
                - greenboot
                - grub2-pc
                - kernel-core
                - langpacks-en
                - lvm2
                - nss-altfiles
                - polkit
                - rpm-ostree
                - selinux-policy-targeted
              excludes:
                - dracut-config-rescue
      - type: org.osbuild.systemd
        options:
          enabled_services:
            - cloud-config
            - cloud-final
            - cloud-init
            - cloud-init-local
      - type: org.osbuild.locale
        options:
          language: en_US.UTF-8
      - type: org.osbuild.systemd-journald
        options:
          filename: 10-persistent.conf
          config:
            Journal:
              Storage: persistent
      - type: org.osbuild.selinux
        options:
          file_contexts: etc/selinux/targeted/contexts/files/file_contexts
  - name: ostree-commit
    build: name:build
    stages:
      - type: org.osbuild.ostree.init
        options:
          path: /repo
      - type: org.osbuild.ostree.commit
        inputs:
          tree:
            type: org.osbuild.tree
            origin: org.osbuild.pipeline
            references:
              - name:ostree-tree
        options:
          ref: fedora/x86_64/osbuild
          os_version:
            mpp-format-string: '{release}'

  - name: container
    build: name:build
    stages:
      - type: org.osbuild.ostree.encapsulate
        options:
          filename: ostree-container.tar
        inputs:
          commit:
            type: org.osbuild.ostree
            origin: org.osbuild.pipeline
            references:
              name:ostree-commit: {}

